{% extends "base.html" %}

{% block title %}Login & Register - FoodExpress{% endblock %}

{% block content %}
<div class="container mt-5 pt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="row">
                <!-- Login Form -->
                <div class="col-md-6 mb-4">
                    <div class="form-container">
                        <h2 class="text-center mb-4">
                            <i class="fas fa-sign-in-alt text-primary me-2"></i>Login
                        </h2>
                        
                        <form id="loginForm">
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="loginUsername" placeholder="Username" required>
                                <label for="loginUsername">Username</label>
                            </div>
                            
                            <div class="form-floating mb-3">
                                <input type="password" class="form-control" id="loginPassword" placeholder="Password" required>
                                <label for="loginPassword">Password</label>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="rememberMe">
                                <label class="form-check-label" for="rememberMe">
                                    Remember me
                                </label>
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-lg w-100 mb-3">
                                <i class="fas fa-sign-in-alt me-2"></i>Login
                            </button>
                        </form>
                        
                        <div class="text-center">
                            <a href="#" class="text-decoration-none">Forgot your password?</a>
                        </div>
                        
                        <!-- Demo Credentials -->
                        <!-- <div class="alert alert-info mt-3">
                            <strong>Demo Credentials:</strong><br>
                            <small>
                                Admin: username: <code>admin</code>, password: <code>admin123</code><br>
                                Or register a new account below
                            </small>
                        </div> -->
                    </div>
                </div>
                
                <!-- Register Form -->
                <div class="col-md-6 mb-4">
                    <div class="form-container">
                        <h2 class="text-center mb-4">
                            <i class="fas fa-user-plus text-primary me-2"></i>Register
                        </h2>
                        
                        <form id="registerForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="firstName" placeholder="First Name" required>
                                        <label for="firstName">First Name</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="lastName" placeholder="Last Name" required>
                                        <label for="lastName">Last Name</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-floating mb-3">
                                <input type="text" class="form-control" id="registerUsername" placeholder="Username" required>
                                <label for="registerUsername">Username</label>
                                <div class="invalid-feedback" id="usernameError"></div>
                            </div>
                            
                            <div class="form-floating mb-3">
                                <input type="email" class="form-control" id="email" placeholder="Email" required>
                                <label for="email">Email Address</label>
                                <div class="invalid-feedback" id="emailError"></div>
                            </div>
                            
                            <div class="form-floating mb-3">
                                <input type="password" class="form-control" id="registerPassword" placeholder="Password" required minlength="6">
                                <label for="registerPassword">Password</label>
                                <div class="form-text">Password must be at least 6 characters long</div>
                            </div>
                            
                            <div class="form-floating mb-3">
                                <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm Password" required>
                                <label for="confirmPassword">Confirm Password</label>
                                <div class="invalid-feedback" id="passwordError"></div>
                            </div>
                            
                            <div class="form-floating mb-3">
                                <input type="tel" class="form-control" id="phoneNumber" placeholder="Phone Number">
                                <label for="phoneNumber">Phone Number (Optional)</label>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                                <label class="form-check-label" for="agreeTerms">
                                    I agree to the <a href="#" class="text-decoration-none">Terms of Service</a> and <a href="#" class="text-decoration-none">Privacy Policy</a>
                                </label>
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-user-plus me-2"></i>Create Account
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Social Login Options -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="text-center">
                        <p class="text-muted mb-3">Or continue with</p>
                        <div class="d-flex justify-content-center gap-3">
                            <button class="btn btn-outline-primary">
                                <i class="fab fa-google me-2"></i>Google
                            </button>
                            <button class="btn btn-outline-primary">
                                <i class="fab fa-facebook me-2"></i>Facebook
                            </button>
                            <button class="btn btn-outline-primary">
                                <i class="fab fa-apple me-2"></i>Apple
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Benefits Section -->
            <div class="row mt-5">
                <div class="col-12">
                    <h4 class="text-center mb-4">Why Create an Account?</h4>
                    <div class="row">
                        <div class="col-md-4 text-center mb-3">
                            <i class="fas fa-clock fa-2x text-primary mb-2"></i>
                            <h6>Faster Checkout</h6>
                            <p class="text-muted small">Save your delivery information for quick ordering</p>
                        </div>
                        <div class="col-md-4 text-center mb-3">
                            <i class="fas fa-history fa-2x text-primary mb-2"></i>
                            <h6>Order History</h6>
                            <p class="text-muted small">Track your orders and reorder your favorites</p>
                        </div>
                        <div class="col-md-4 text-center mb-3">
                            <i class="fas fa-gift fa-2x text-primary mb-2"></i>
                            <h6>Exclusive Offers</h6>
                            <p class="text-muted small">Get special discounts and promotions</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Login Form Handler
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    const submitBtn = this.querySelector('button[type="submit"]');
    
    const originalText = showLoading(submitBtn);
    
    try {
        const success = await login(username, password);
        if (success) {
            setTimeout(() => {
                window.location.href = '/';
            }, 1000);
        }
    } catch (error) {
        console.error('Login error:', error);
    } finally {
        hideLoading(submitBtn, originalText);
    }
});

// Register Form Handler
document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Clear previous errors
    clearValidationErrors();
    
    // Get form data
    const formData = {
        username: document.getElementById('registerUsername').value,
        email: document.getElementById('email').value,
        password: document.getElementById('registerPassword').value,
        first_name: document.getElementById('firstName').value,
        last_name: document.getElementById('lastName').value,
        phone_number: document.getElementById('phoneNumber').value
    };
    
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    // Validate form
    if (!validateRegistrationForm(formData, confirmPassword)) {
        return;
    }
    
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = showLoading(submitBtn);
    
    try {
        const success = await register(formData);
        if (success) {
            // Clear form
            this.reset();
            // Show login form
            document.getElementById('loginUsername').value = formData.username;
            document.getElementById('loginUsername').focus();
        }
    } catch (error) {
        console.error('Registration error:', error);
    } finally {
        hideLoading(submitBtn, originalText);
    }
});

// Form Validation
function validateRegistrationForm(data, confirmPassword) {
    let isValid = true;
    
    // Username validation
    if (data.username.length < 3) {
        showFieldError('registerUsername', 'Username must be at least 3 characters long');
        isValid = false;
    }
    
    // Email validation
    if (!validateEmail(data.email)) {
        showFieldError('email', 'Please enter a valid email address');
        isValid = false;
    }
    
    // Password validation
    if (!validatePassword(data.password)) {
        showFieldError('registerPassword', 'Password must be at least 6 characters long');
        isValid = false;
    }
    
    // Confirm password validation
    if (data.password !== confirmPassword) {
        showFieldError('confirmPassword', 'Passwords do not match');
        isValid = false;
    }
    
    return isValid;
}

function showFieldError(fieldId, message) {
    const field = document.getElementById(fieldId);
    const errorDiv = document.getElementById(fieldId.replace('register', '').toLowerCase() + 'Error') || 
                     document.getElementById('passwordError');
    
    field.classList.add('is-invalid');
    if (errorDiv) {
        errorDiv.textContent = message;
    }
}

function clearValidationErrors() {
    const fields = ['registerUsername', 'email', 'registerPassword', 'confirmPassword'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        field.classList.remove('is-invalid');
    });
    
    const errorDivs = ['usernameError', 'emailError', 'passwordError'];
    errorDivs.forEach(errorId => {
        const errorDiv = document.getElementById(errorId);
        if (errorDiv) {
            errorDiv.textContent = '';
        }
    });
}

// Real-time validation
document.getElementById('registerUsername').addEventListener('blur', function() {
    if (this.value.length > 0 && this.value.length < 3) {
        showFieldError('registerUsername', 'Username must be at least 3 characters long');
    } else {
        this.classList.remove('is-invalid');
    }
});

document.getElementById('email').addEventListener('blur', function() {
    if (this.value.length > 0 && !validateEmail(this.value)) {
        showFieldError('email', 'Please enter a valid email address');
    } else {
        this.classList.remove('is-invalid');
    }
});

document.getElementById('confirmPassword').addEventListener('input', function() {
    const password = document.getElementById('registerPassword').value;
    if (this.value.length > 0 && this.value !== password) {
        showFieldError('confirmPassword', 'Passwords do not match');
    } else {
        this.classList.remove('is-invalid');
    }
});

// Check if user is already logged in
document.addEventListener('DOMContentLoaded', function() {
    const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
    if (isLoggedIn) {
        window.location.href = '/';
    }
});
</script>
{% endblock %}

